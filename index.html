<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinansPro v1.0 | Kişisel Bütçe Yönetimi</title>

    <!-- Core Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 900: '#312e81' },
                        dark: { 800: '#1e293b', 900: '#0f172a' }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f1f5f9;
            -webkit-font-smoothing: antialiased;
        }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .glass-dark {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>

<body class="text-slate-800 h-screen overflow-hidden">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- ICONS (Lucide Style) ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                dashboard: <path d="M3 3h7v9H3zM14 3h7v5h-7zM14 12h7v9h-7zM3 16h7v5H3z" />,
                wallet: <path d="M21 7V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2"/><path d="M5 5v13a1 1 0 0 0 1 1h15V6a1 1 0 0 0-1-1H5z"/><path d="M16 11h4"/>,
                calendar: <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>,
                chart: <path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-6"/>,
                installments: <rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/>,
                history: <path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="10"/>,
                plus: <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>,
                trash: <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>,
                check: <polyline points="20 6 9 17 4 12" />,
                x: <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>,
                download: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>,
                menu: <line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/>,
                search: <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>,
                chevronRight: <polyline points="9 18 15 12 9 6" />,
                chevronLeft: <polyline points="15 18 9 12 15 6" />
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );
        };

        // --- CONSTANTS & INITIAL DATA ---
        const MONTHS = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
        const INITIAL_CATEGORIES = {
            income: [
                { id: 1, name: "Maaş", planned: 0, actual: 0 },
                { id: 2, name: "Ek Ders / Prim", planned: 0, actual: 0 }
            ],
            basicNeeds: [
                { id: 101, name: "Kira", planned: 0, actual: 0, isPaid: false },
                { id: 102, name: "Mutfak", planned: 0, actual: 0, isPaid: false },
                { id: 103, name: "Faturalar", planned: 0, actual: 0, isPaid: false }
            ],
            discretionary: [
                { id: 201, name: "Yeme-İçme", planned: 0, actual: 0, isPaid: false },
                { id: 202, name: "Eğlence", planned: 0, actual: 0, isPaid: false }
            ],
            savings: [
                { id: 301, name: "Altın", planned: 0, actual: 0 },
                { id: 302, name: "Borsa", planned: 0, actual: 0 }
            ]
        };

        // --- UTILS ---
        const formatMoney = (val) => new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY', maximumFractionDigits: 0 }).format(val || 0);
        const uuid = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

        // --- COMPONENTS ---

        // 1. Sidebar
        const Sidebar = ({ activeTab, onTabChange, onQuickAdd }) => {
            const items = [
                { id: 'dashboard', label: 'Genel Bakış', icon: 'dashboard' },
                { id: 'budget', label: 'Bütçe Planı', icon: 'calendar' },
                { id: 'assets', label: 'Varlıklar', icon: 'wallet' },
                { id: 'installments', label: 'Taksitler', icon: 'installments' },
                { id: 'history', label: 'Geçmiş', icon: 'history' },
            ];

            return (
                <div className="hidden md:flex w-72 bg-dark-900 text-slate-300 flex-col h-full border-r border-slate-800 shadow-2xl z-20">
                    <div className="p-8 pb-4">
                        <div className="flex items-center gap-3 text-brand-500 mb-2">
                            <div className="p-2 bg-brand-500/10 rounded-lg"><Icon name="chart" size={24} /></div>
                            <h1 className="text-2xl font-bold tracking-tight text-white">FinansPro</h1>
                        </div>
                        <p className="text-xs text-slate-500 font-medium ml-1">Kişisel Varlık Yönetimi</p>
                    </div>

                    <nav className="flex-1 px-4 py-6 space-y-1">
                        {items.map(item => (
                            <button
                                key={item.id}
                                onClick={() => onTabChange(item.id)}
                                className={`w-full flex items-center gap-3 px-4 py-3.5 rounded-xl transition-all duration-200 group ${activeTab === item.id ? 'bg-brand-600/90 text-white shadow-lg shadow-brand-900/50' : 'hover:bg-slate-800 hover:text-white'}`}
                            >
                                <Icon name={item.icon} className={activeTab === item.id ? 'text-white' : 'text-slate-500 group-hover:text-white transition-colors'} />
                                <span className="font-medium">{item.label}</span>
                                {activeTab === item.id && <Icon name="chevronRight" size={14} className="ml-auto opacity-50" />}
                            </button>
                        ))}
                    </nav>

                    <div className="p-4 border-t border-slate-800 space-y-3">
                        <button onClick={onQuickAdd} className="w-full bg-gradient-to-r from-emerald-500 to-teal-500 text-white p-3.5 rounded-xl font-bold hover:shadow-lg hover:shadow-emerald-900/30 transition-all active:scale-[0.98] flex items-center justify-center gap-2">
                            <Icon name="plus" size={18} /> Hızlı Ekle
                        </button>
                    </div>
                </div>
            );
        };

        // 2. Mobile Nav
        const MobileNav = ({ activeTab, onTabChange, onQuickAdd }) => {
            const items = [
                { id: 'dashboard', icon: 'dashboard' },
                { id: 'budget', icon: 'calendar' },
                { id: 'assets', icon: 'wallet' },
                { id: 'history', icon: 'history' },
            ];
            return (
                <>
                    <div className="md:hidden fixed bottom-0 left-0 w-full bg-white/90 backdrop-blur-md border-t border-slate-200 flex justify-between px-6 py-2 pb-6 z-50 shadow-[0_-5px_20px_-5px_rgba(0,0,0,0.1)]">
                        {items.map(item => (
                            <button
                                key={item.id}
                                onClick={() => onTabChange(item.id)}
                                className={`p-3 rounded-2xl flex flex-col items-center transition-all ${activeTab === item.id ? 'text-brand-600 bg-brand-50' : 'text-slate-400'}`}
                            >
                                <Icon name={item.icon} size={24} />
                            </button>
                        ))}
                        <button onClick={onQuickAdd} className="absolute -top-6 left-1/2 -translate-x-1/2 bg-dark-900 text-white p-4 rounded-full shadow-xl shadow-brand-900/30 border-4 border-slate-50 active:scale-95 transition-transform">
                            <Icon name="plus" size={24} />
                        </button>
                    </div>
                </>
            );
        };

        // 3. Components for Modules
        const StatCard = ({ title, value, sub, colorPkg, icon }) => (
            <div className={`relative overflow-hidden rounded-2xl p-5 border transition-all hover:shadow-md ${colorPkg.bg} ${colorPkg.border}`}>
                <div className="relative z-10">
                    <p className={`text-xs font-bold uppercase tracking-wider mb-1 ${colorPkg.textSub}`}>{title}</p>
                    <h3 className={`text-2xl font-black ${colorPkg.textMain}`}>{value}</h3>
                    {sub && <p className={`text-[10px] mt-1 font-medium ${colorPkg.textSub}`}>{sub}</p>}
                </div>
                <div className={`absolute -right-3 -bottom-3 opacity-10 ${colorPkg.textMain}`}>
                    <Icon name={icon} size={80} />
                </div>
            </div>
        );

        const ProgressBar = ({ val, max, color }) => {
            const pct = Math.min(100, Math.max(0, (val / max) * 100));
            return (
                <div className="w-full bg-slate-100 rounded-full h-1.5 mt-2 overflow-hidden">
                    <div className={`h-full rounded-full transition-all duration-500 ${color}`} style={{ width: `${pct}%` }}></div>
                </div>
            );
        }

        // --- MODULES ---

        // DASHBOARD
        const Dashboard = ({ summary, assetsTotal }) => {
            const chartMax = Math.max(summary.inc, summary.totExp, summary.sav, 1);
            return (
                <div className="space-y-6 animate-fade-in pb-24 md:pb-0">
                    <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <StatCard
                            title="Toplam Gelir"
                            value={formatMoney(summary.inc)}
                            sub="Bu ayki tüm girişler"
                            icon="wallet"
                            colorPkg={{ bg: 'bg-emerald-50/50', border: 'border-emerald-100', textMain: 'text-emerald-700', textSub: 'text-emerald-600' }}
                        />
                        <StatCard
                            title="Toplam Gider"
                            value={formatMoney(summary.totExp)}
                            sub={`${formatMoney(summary.pending)} ödenecek`}
                            icon="chart"
                            colorPkg={{ bg: 'bg-rose-50/50', border: 'border-rose-100', textMain: 'text-rose-700', textSub: 'text-rose-600' }}
                        />
                        <StatCard
                            title="Net Durum"
                            value={formatMoney(summary.inc - summary.totExp)}
                            sub="Gelir - Gider"
                            icon="dashboard"
                            colorPkg={{ bg: 'bg-blue-50/50', border: 'border-blue-100', textMain: 'text-blue-700', textSub: 'text-blue-600' }}
                        />
                        <StatCard
                            title="Toplam Servet"
                            value={formatMoney(assetsTotal)}
                            sub="Tüm Varlıklar"
                            icon="installments"
                            colorPkg={{ bg: 'bg-amber-50/50', border: 'border-amber-100', textMain: 'text-amber-700', textSub: 'text-amber-600' }}
                        />
                    </div>

                    <div className="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm">
                        <h3 className="text-sm font-bold text-slate-500 uppercase mb-6 flex items-center gap-2"><Icon name="chart" size={16} /> Aylık Özet Grafiği</h3>
                        <div className="space-y-6">
                            <div>
                                <div className="flex justify-between text-sm mb-1"><span className="font-semibold text-emerald-700">Gelir</span><span className="font-bold">{formatMoney(summary.inc)}</span></div>
                                <ProgressBar val={summary.inc} max={chartMax} color="bg-emerald-500" />
                            </div>
                            <div>
                                <div className="flex justify-between text-sm mb-1"><span className="font-semibold text-rose-700">Gider</span><span className="font-bold">{formatMoney(summary.totExp)}</span></div>
                                <ProgressBar val={summary.totExp} max={chartMax} color="bg-rose-500" />
                            </div>
                            <div>
                                <div className="flex justify-between text-sm mb-1"><span className="font-semibold text-brand-700">Tasarruf</span><span className="font-bold">{formatMoney(summary.sav)}</span></div>
                                <ProgressBar val={summary.sav} max={chartMax} color="bg-brand-500" />
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // BUDGET
        const Budget = ({ monthIdx, setMonthIdx, data, updateItem, addItem, delItem, togglePaid, installments }) => {
            const renderTable = (groupKey, title, colorInfo) => {
                const items = data[groupKey] || [];
                const total = items.reduce((a, b) => a + (Number(b.actual) || 0), 0);

                return (
                    <div className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden flex flex-col h-full">
                        <div className={`p-4 border-b ${colorInfo.bg} flex justify-between items-center`}>
                            <h3 className={`font-bold ${colorInfo.text}`}>{title}</h3>
                            <button onClick={() => addItem(groupKey)} className={`p-1.5 rounded-lg bg-white/50 hover:bg-white text-slate-700 transition-colors shadow-sm`}><Icon name="plus" size={16} /></button>
                        </div>
                        <div className="p-2 flex-1 overflow-auto">
                            {items.length === 0 && <div className="p-4 text-center text-slate-400 text-xs italic">Kalem eklenmedi.</div>}
                            {items.map(item => (
                                <div key={item.id} className="group flex items-center gap-2 p-2 rounded-lg hover:bg-slate-50 transition-colors">
                                    {groupKey !== 'income' && groupKey !== 'savings' && (
                                        <button onClick={() => togglePaid(groupKey, item.id)} className={`transition-colors ${item.isPaid ? 'text-emerald-500' : 'text-slate-300 hover:text-slate-400'}`}>
                                            {item.isPaid ? <Icon name="check" size={18} className="stroke-[3]" /> : <div className="w-[18px] h-[18px] border-2 rounded-full border-current"></div>}
                                        </button>
                                    )}
                                    <div className="flex-1 min-w-0">
                                        <input
                                            value={item.name}
                                            onChange={(e) => updateItem(groupKey, item.id, 'name', e.target.value)}
                                            className={`w-full bg-transparent text-sm font-medium outline-none text-slate-700 ${item.isPaid ? 'opacity-50 line-through' : ''}`}
                                        />
                                    </div>
                                    <div className="relative">
                                        <input
                                            type="number"
                                            value={item.actual}
                                            onChange={(e) => updateItem(groupKey, item.id, 'actual', e.target.value)}
                                            className="w-20 text-right text-sm font-semibold bg-slate-50 border border-slate-200 rounded px-2 py-1 outline-none focus:border-brand-500 focus:ring-1 focus:ring-brand-500 transition-all"
                                        />
                                    </div>
                                    <button onClick={() => delItem(groupKey, item.id)} className="opacity-0 group-hover:opacity-100 p-1 text-slate-300 hover:text-rose-500 transition-all"><Icon name="trash" size={14} /></button>
                                </div>
                            ))}
                        </div>
                        <div className="p-3 bg-slate-50 border-t flex justify-between items-center text-xs font-bold text-slate-600">
                            <span>TOPLAM</span>
                            <span>{formatMoney(total)}</span>
                        </div>
                    </div>
                );
            };

            const monthInsts = installments.filter(i => {
                const end = i.startMonthIndex + i.installmentCount - 1;
                return monthIdx >= i.startMonthIndex && monthIdx <= end;
            });
            const instTotal = monthInsts.reduce((a, b) => a + b.monthlyAmount, 0);

            return (
                <div className="space-y-6 animate-fade-in pb-24 md:pb-0 h-full flex flex-col">
                    <div className="flex items-center justify-between bg-white p-2 rounded-2xl border shadow-sm shrink-0">
                        <button onClick={() => setMonthIdx(Math.max(0, monthIdx - 1))} className="p-2 hover:bg-slate-100 rounded-lg disabled:opacity-30" disabled={monthIdx === 0}><Icon name="chevronLeft" /></button>
                        <span className="font-extrabold text-lg w-32 text-center text-slate-800">{MONTHS[monthIdx]}</span>
                        <button onClick={() => setMonthIdx(Math.min(11, monthIdx + 1))} className="p-2 hover:bg-slate-100 rounded-lg disabled:opacity-30" disabled={monthIdx === 11}><Icon name="chevronRight" /></button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 flex-1 overflow-y-auto pb-4">
                        {/* Column 1: Income & Savings */}
                        <div className="space-y-6">
                            {renderTable('income', 'Gelirler', { bg: 'bg-emerald-50', text: 'text-emerald-800' })}
                            {renderTable('savings', 'Tasarruflar', { bg: 'bg-brand-50', text: 'text-brand-800' })}
                        </div>

                        {/* Column 2: Basic Expenses */}
                        <div className="h-full">
                            {renderTable('basicNeeds', 'Temel Giderler', { bg: 'bg-rose-50', text: 'text-rose-800' })}
                        </div>

                        {/* Column 3: Configurable & Installments */}
                        <div className="space-y-6">
                            {monthInsts.length > 0 && (
                                <div className="bg-amber-50 rounded-2xl border border-amber-200 p-4">
                                    <h3 className="font-bold text-amber-800 text-sm mb-3 flex justify-between">Otomatik Taksitler <span>{formatMoney(instTotal)}</span></h3>
                                    <div className="space-y-2">
                                        {monthInsts.map(i => (
                                            <div key={i.id} className="flex justify-between text-xs font-medium text-amber-900/70 border-b border-amber-200/50 pb-1 last:border-0">
                                                <span>{i.name}</span>
                                                <span>{formatMoney(i.monthlyAmount)}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            {renderTable('discretionary', 'Keyfi Harcamalar', { bg: 'bg-purple-50', text: 'text-purple-800' })}
                        </div>
                    </div>
                </div>
            );
        };

        // ASSETS
        const Assets = ({ assets, setAssets }) => {
            const addAsset = () => setAssets([...assets, { id: uuid(), type: 'Altın', count: 1, unitPrice: 1000, total: 1000 }]);
            const removeAsset = (id) => setAssets(assets.filter(a => a.id !== id));
            const updateAsset = (id, field, val) => {
                setAssets(assets.map(a => {
                    if (a.id !== id) return a;
                    const u = { ...a, [field]: field === 'type' ? val : Number(val) };
                    u.total = u.count * u.unitPrice;
                    return u;
                }));
            };
            const totalWealth = assets.reduce((a, b) => a + b.total, 0);

            return (
                <div className="space-y-6 animate-fade-in pb-24 md:pb-0">
                    <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl p-8 text-white shadow-xl relative overflow-hidden">
                        <div className="relative z-10">
                            <p className="opacity-60 font-medium mb-1">Net Varlık Değeri</p>
                            <h2 className="text-4xl font-bold tracking-tight">{formatMoney(totalWealth)}</h2>
                        </div>
                        <Icon name="wallet" size={150} className="absolute -right-6 -bottom-10 opacity-10 rotate-12" />
                    </div>

                    <div className="bg-white border rounded-2xl overflow-hidden shadow-sm">
                        <div className="p-4 bg-slate-50 border-b flex justify-between items-center">
                            <h3 className="font-bold text-slate-700">Portföy Detayı</h3>
                            <button onClick={addAsset} className="text-xs font-bold bg-slate-200 hover:bg-slate-300 px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1">+ YENİ</button>
                        </div>
                        <div className="hidden md:grid grid-cols-12 gap-4 p-3 text-xs font-bold text-slate-400 uppercase tracking-wider bg-slate-50/50 border-b">
                            <div className="col-span-4">Varlık Tipi</div>
                            <div className="col-span-2 text-center">Adet/Miktar</div>
                            <div className="col-span-3 text-right">Birim Fiyat</div>
                            <div className="col-span-2 text-right">Toplam</div>
                            <div className="col-span-1"></div>
                        </div>
                        {assets.map(a => (
                            <div key={a.id} className="grid grid-cols-1 md:grid-cols-12 gap-2 md:gap-4 p-4 border-b last:border-0 items-center hover:bg-slate-50 transition-colors">
                                <div className="col-span-4"><input value={a.type} onChange={e => updateAsset(a.id, 'type', e.target.value)} className="w-full font-semibold text-slate-700 bg-transparent outline-none border-b border-transparent focus:border-brand-500" placeholder="Varlık Tipi" /></div>
                                <div className="col-span-2 flex items-center gap-2 md:justify-center"><span className="md:hidden text-xs text-slate-400 w-16">Adet:</span><input type="number" value={a.count} onChange={e => updateAsset(a.id, 'count', e.target.value)} className="w-full md:w-24 text-center bg-slate-50 border rounded p-1" /></div>
                                <div className="col-span-3 flex items-center gap-2 md:justify-end"><span className="md:hidden text-xs text-slate-400 w-16">Birim:</span><input type="number" value={a.unitPrice} onChange={e => updateAsset(a.id, 'unitPrice', e.target.value)} className="w-full md:w-28 text-right bg-slate-50 border rounded p-1" /></div>
                                <div className="col-span-2 text-right font-bold text-emerald-600">{formatMoney(a.total)}</div>
                                <div className="col-span-1 text-right"><button onClick={() => removeAsset(a.id)} className="text-slate-300 hover:text-rose-500"><Icon name="trash" size={16} /></button></div>
                            </div>
                        ))}
                    </div>
                </div>
            )
        };

        const Installments = ({ installments, setInstallments }) => {
            const [form, setForm] = useState({ name: '', totalAmount: '', installmentCount: 3, startMonthIndex: new Date().getMonth() });

            const add = () => {
                if (!form.name || !form.totalAmount) return;
                const monthly = Number(form.totalAmount) / Number(form.installmentCount);
                setInstallments([...installments, { ...form, id: uuid(), monthlyAmount: monthly, totalAmount: Number(form.totalAmount), installmentCount: Number(form.installmentCount), startMonthIndex: Number(form.startMonthIndex) }]);
                setForm({ name: '', totalAmount: '', installmentCount: 3, startMonthIndex: new Date().getMonth() });
            };

            return (
                <div className="space-y-6 animate-fade-in pb-24 md:pb-0">
                    <div className="bg-white p-6 rounded-2xl border shadow-sm">
                        <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><Icon name="installments" /> Yeni Taksit Planı</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3">
                            <input className="lg:col-span-2 border p-2.5 rounded-xl text-sm outline-none focus:ring-2 focus:ring-brand-500" placeholder="Harcama Açıklaması" value={form.name} onChange={e => setForm({ ...form, name: e.target.value })} />
                            <input className="border p-2.5 rounded-xl text-sm outline-none focus:ring-2 focus:ring-brand-500" type="number" placeholder="Toplam Tutar" value={form.totalAmount} onChange={e => setForm({ ...form, totalAmount: e.target.value })} />
                            <div className="flex gap-2">
                                <select className="border p-2.5 rounded-xl text-sm bg-white" value={form.installmentCount} onChange={e => setForm({ ...form, installmentCount: e.target.value })}>{[2, 3, 4, 6, 9, 12, 24].map(x => <option key={x} value={x}>{x} Taksit</option>)}</select>
                                <select className="border p-2.5 rounded-xl text-sm bg-white" value={form.startMonthIndex} onChange={e => setForm({ ...form, startMonthIndex: e.target.value })}>{MONTHS.map((m, i) => <option key={i} value={i}>{m}</option>)}</select>
                            </div>
                            <button onClick={add} className="bg-brand-600 text-white font-bold rounded-xl hover:bg-brand-700 transition-colors">EKLE</button>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {installments.map(i => (
                            <div key={i.id} className="bg-white p-5 rounded-2xl border shadow-sm relative group">
                                <div className="flex justify-between items-start mb-2">
                                    <h4 className="font-bold text-lg text-slate-800">{i.name}</h4>
                                    <button onClick={() => setInstallments(installments.filter(x => x.id !== i.id))} className="text-slate-300 hover:text-rose-500"><Icon name="trash" size={16} /></button>
                                </div>
                                <div className="flex justify-between items-end">
                                    <div className="text-sm text-slate-500 space-y-1">
                                        <p>Toplam: {formatMoney(i.totalAmount)}</p>
                                        <p className="text-xs bg-slate-100 inline-block px-2 py-1 rounded">Başlangıç: {MONTHS[i.startMonthIndex]}</p>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-xl font-black text-rose-600">{formatMoney(i.monthlyAmount)}</div>
                                        <div className="text-xs font-bold text-slate-400 uppercase">{i.installmentCount} AY BOYUNCA</div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            )
        };

        const History = ({ transactions, onDelete }) => (
            <div className="space-y-6 animate-fade-in pb-24 md:pb-0">
                <div className="bg-white rounded-2xl border shadow-sm overflow-hidden">
                    <table className="w-full text-sm text-left">
                        <thead className="bg-slate-50 text-slate-500 text-xs uppercase font-bold">
                            <tr>
                                <th className="p-4">Tarih</th>
                                <th className="p-4">Kategori</th>
                                <th className="p-4">Açıklama</th>
                                <th className="p-4 text-right">Tutar</th>
                                <th className="p-4 w-10"></th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100">
                            {transactions.sort((a, b) => new Date(b.date) - new Date(a.date)).map(tx => (
                                <tr key={tx.id} className="hover:bg-slate-50 transition-colors group">
                                    <td className="p-4 font-medium text-slate-600">{new Date(tx.date).toLocaleDateString('tr-TR')}</td>
                                    <td className="p-4"><span className="px-2 py-1 rounded-md bg-indigo-50 text-indigo-700 text-xs font-bold">{tx.catName}</span></td>
                                    <td className="p-4 text-slate-500">{tx.desc}</td>
                                    <td className={`p-4 text-right font-bold ${tx.type === 'income' ? 'text-emerald-600' : 'text-rose-600'}`}>{tx.type === 'income' ? '+' : '-'}{formatMoney(tx.amount)}</td>
                                    <td className="p-4 text-center"><button onClick={() => onDelete(tx)} className="text-slate-300 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="trash" size={16} /></button></td>
                                </tr>
                            ))}
                            {transactions.length === 0 && <tr><td colSpan="5" className="p-8 text-center text-slate-400">İşlem geçmişi boş.</td></tr>}
                        </tbody>
                    </table>
                </div>
            </div>
        );

        // --- MAIN APP ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [monthIdx, setMonthIdx] = useState(new Date().getMonth());
            const [showQuickAdd, setShowQuickAdd] = useState(false);

            // Data State
            const [budgetData, setBudgetData] = useState(() => {
                const saved = localStorage.getItem('finans_pro_db_v1');
                if (saved) return JSON.parse(saved);
                const initial = {};
                MONTHS.forEach((_, i) => initial[i] = JSON.parse(JSON.stringify(INITIAL_CATEGORIES)));
                return initial;
            });
            const [assets, setAssets] = useState(() => JSON.parse(localStorage.getItem('finans_pro_assets_v1') || '[]'));
            const [installments, setInstallments] = useState(() => JSON.parse(localStorage.getItem('finans_pro_inst_v1') || '[]'));
            const [transactions, setTransactions] = useState(() => JSON.parse(localStorage.getItem('finans_pro_tx_v1') || '[]'));

            // Persistence
            useEffect(() => localStorage.setItem('finans_pro_db_v1', JSON.stringify(budgetData)), [budgetData]);
            useEffect(() => localStorage.setItem('finans_pro_assets_v1', JSON.stringify(assets)), [assets]);
            useEffect(() => localStorage.setItem('finans_pro_inst_v1', JSON.stringify(installments)), [installments]);
            useEffect(() => localStorage.setItem('finans_pro_tx_v1', JSON.stringify(transactions)), [transactions]);

            // CRUD Helpers
            const updateItem = (group, id, field, val) => {
                setBudgetData(prev => ({
                    ...prev,
                    [monthIdx]: {
                        ...prev[monthIdx],
                        [group]: prev[monthIdx][group].map(i => i.id === id ? { ...i, [field]: field === 'name' ? val : Number(v) } : i)
                    }
                }));
            };
            const togglePaid = (group, id) => {
                setBudgetData(prev => ({
                    ...prev,
                    [monthIdx]: {
                        ...prev[monthIdx],
                        [group]: prev[monthIdx][group].map(i => i.id === id ? { ...i, isPaid: !i.isPaid } : i)
                    }
                }));
            };
            const addItem = (group) => {
                setBudgetData(prev => ({
                    ...prev,
                    [monthIdx]: { ...prev[monthIdx], [group]: [...prev[monthIdx][group], { id: uuid(), name: 'Yeni Kalem', planned: 0, actual: 0, isPaid: false }] }
                }));
            };
            const delItem = (group, id) => {
                setBudgetData(prev => ({
                    ...prev,
                    [monthIdx]: { ...prev[monthIdx], [group]: prev[monthIdx][group].filter(i => i.id !== id) }
                }));
            };

            // Quick Add Logic
            const performQuickAdd = (data) => {
                // data: { amount, desc, date, catId (group|id) }
                const dateObj = new Date(data.date);
                const targetM = dateObj.getMonth();
                const [group, itemId] = data.catId.split('|');
                const amt = Number(data.amount);

                // Update Budget
                setBudgetData(prev => {
                    const monthData = prev[targetM];
                    let catName = 'Genel';
                    const newGroupItems = monthData[group].map(item => {
                        if (String(item.id) === String(itemId)) {
                            catName = item.name;
                            return { ...item, actual: (Number(item.actual) || 0) + amt };
                        }
                        return item;
                    });

                    // Log Transaction inside the setter to ensure consistency? No, separation is fine but we need catName.
                    // We'll trust the map found it.

                    const newTx = {
                        id: uuid(),
                        date: data.date,
                        amount: amt,
                        desc: data.desc || catName,
                        monthIndex: targetM,
                        catGroup: group,
                        catId: itemId,
                        catName: catName,
                        type: group === 'income' ? 'income' : 'expense'
                    };
                    setTransactions(t => [newTx, ...t]);

                    return { ...prev, [targetM]: { ...prev[targetM], [group]: newGroupItems } };
                });
                setShowQuickAdd(false);
            };

            const rollbackTransaction = (tx) => {
                setBudgetData(prev => {
                    const monthData = prev[tx.monthIndex];
                    if (!monthData) return prev; // Safety

                    const newGroupItems = monthData[tx.catGroup].map(item => {
                        if (String(item.id) === String(tx.catId)) {
                            return { ...item, actual: Math.max(0, (Number(item.actual) || 0) - Number(tx.amount)) };
                        }
                        return item;
                    });
                    return { ...prev, [tx.monthIndex]: { ...prev[tx.monthIndex], [tx.catGroup]: newGroupItems } };
                });
                setTransactions(prev => prev.filter(t => t.id !== tx.id));
            };

            // Calculation for Dashboard
            const currentSummary = useMemo(() => {
                const d = budgetData[monthIdx];
                const inc = d.income.reduce((a, c) => a + (c.actual || 0), 0);
                const sav = d.savings.reduce((a, c) => a + (c.actual || 0), 0);
                const basic = d.basicNeeds.reduce((a, c) => a + (c.actual || 0), 0);
                const disc = d.discretionary.reduce((a, c) => a + (c.actual || 0), 0);

                // Installments
                const monthInsts = installments.filter(i => {
                    const end = i.startMonthIndex + i.installmentCount - 1;
                    return monthIdx >= i.startMonthIndex && monthIdx <= end;
                });
                const instTot = monthInsts.reduce((a, b) => a + b.monthlyAmount, 0);
                const totExp = basic + disc + instTot;

                const paidBasic = d.basicNeeds.filter(i => i.isPaid).reduce((a, c) => a + (c.actual || 0), 0);
                const paidDisc = d.discretionary.filter(i => i.isPaid).reduce((a, c) => a + (c.actual || 0), 0);
                const pending = totExp - paidBasic - paidDisc - instTot; // Installments are auto 'pending' or 'paid'? Let's assume paid for math or pure expense. User can't click pay on them here. Assuming realized immediately.

                return { inc, totExp, sav, pending };
            }, [budgetData, monthIdx, installments]);

            const assetsTotal = assets.reduce((a, b) => a + b.total, 0);

            // Quick Add Modal Component (Inline for closure access)
            const QuickAddModal = () => {
                const [qData, setQData] = useState({ date: new Date().toISOString().split('T')[0], amount: '', desc: '', catId: '' });
                const currentM = new Date(qData.date).getMonth();
                const opts = budgetData[currentM];

                return (
                    <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
                        <div className="absolute inset-0 bg-dark-900/60 backdrop-blur-sm" onClick={() => setShowQuickAdd(false)}></div>
                        <div className="bg-white w-full max-w-md rounded-3xl shadow-2xl relative overflow-hidden animate-slide-up">
                            <div className="p-6 bg-dark-900 text-white flex justify-between items-center">
                                <h3 className="font-bold text-lg flex items-center gap-2"><Icon name="plus" className="text-emerald-400" /> Hızlı İşlem</h3>
                                <button onClick={() => setShowQuickAdd(false)} className="hover:bg-white/10 p-2 rounded-full"><Icon name="x" /></button>
                            </div>
                            <div className="p-6 space-y-4">
                                <div className="space-y-1">
                                    <label className="text-xs font-bold text-slate-500 uppercase">Tarih</label>
                                    <input type="date" value={qData.date} onChange={e => setQData({ ...qData, date: e.target.value })} className="w-full border-slate-200 border rounded-xl p-3 outline-none focus:border-brand-500" />
                                </div>
                                <div className="space-y-1">
                                    <label className="text-xs font-bold text-slate-500 uppercase">Kategori</label>
                                    <select value={qData.catId} onChange={e => setQData({ ...qData, catId: e.target.value })} className="w-full border-slate-200 border rounded-xl p-3 outline-none focus:border-brand-500 bg-white">
                                        <option value="">Seçiniz</option>
                                        <optgroup label="Gelirler">
                                            {opts.income.map(i => <option key={i.id} value={`income|${i.id}`}>{i.name}</option>)}
                                        </optgroup>
                                        <optgroup label="Giderler">
                                            {opts.basicNeeds.map(i => <option key={i.id} value={`basicNeeds|${i.id}`}>{i.name}</option>)}
                                            {opts.discretionary.map(i => <option key={i.id} value={`discretionary|${i.id}`}>{i.name}</option>)}
                                        </optgroup>
                                        <optgroup label="Tasarruflar">
                                            {opts.savings.map(i => <option key={i.id} value={`savings|${i.id}`}>{i.name}</option>)}
                                        </optgroup>
                                    </select>
                                </div>
                                <div className="space-y-1">
                                    <label className="text-xs font-bold text-slate-500 uppercase">Tutar</label>
                                    <input type="number" placeholder="0.00" value={qData.amount} onChange={e => setQData({ ...qData, amount: e.target.value })} className="w-full border-slate-200 border rounded-xl p-3 text-lg font-bold outline-none focus:border-brand-500" />
                                </div>
                                <div className="space-y-1">
                                    <label className="text-xs font-bold text-slate-500 uppercase">Açıklama</label>
                                    <input placeholder="Opsiyonel not..." value={qData.desc} onChange={e => setQData({ ...qData, desc: e.target.value })} className="w-full border-slate-200 border rounded-xl p-3 outline-none focus:border-brand-500" />
                                </div>
                                <button onClick={() => performQuickAdd(qData)} disabled={!qData.amount || !qData.catId} className="w-full bg-brand-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-brand-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-lg shadow-brand-500/30">KAYDET</button>
                            </div>
                        </div>
                    </div>
                );
            };

            const downloadBackup = () => {
                const data = { budget: budgetData, assets, installments, transactions };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `finans_yedek_${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
            };

            return (
                <div className="flex h-full bg-slate-100 font-sans text-slate-800">
                    <Sidebar activeTab={activeTab} onTabChange={setActiveTab} onQuickAdd={() => setShowQuickAdd(true)} />

                    <main className="flex-1 flex flex-col h-full relative overflow-hidden">
                        <div className="md:hidden flex items-center justify-between p-4 bg-white border-b sticky top-0 z-40">
                            <span className="font-bold text-brand-600 flex items-center gap-2"><Icon name="chart" /> FinansPro</span>
                            <button onClick={downloadBackup} className="text-slate-400"><Icon name="download" /></button>
                        </div>

                        <div className="flex-1 overflow-y-auto overflow-x-hidden p-4 md:p-8 scroll-smooth">
                            <div className="max-w-6xl mx-auto h-full">
                                {activeTab === 'dashboard' && <Dashboard summary={currentSummary} assetsTotal={assetsTotal} />}
                                {activeTab === 'budget' && <Budget monthIdx={monthIdx} setMonthIdx={setMonthIdx} data={budgetData[monthIdx]} updateItem={updateItem} addItem={addItem} delItem={delItem} togglePaid={togglePaid} installments={installments} />}
                                {activeTab === 'assets' && <Assets assets={assets} setAssets={setAssets} />}
                                {activeTab === 'installments' && <Installments installments={installments} setInstallments={setInstallments} />}
                                {activeTab === 'history' && <History transactions={transactions} onDelete={rollbackTransaction} />}
                            </div>
                        </div>

                    </main>

                    <MobileNav activeTab={activeTab} onTabChange={setActiveTab} onQuickAdd={() => setShowQuickAdd(true)} />
                    {showQuickAdd && <QuickAddModal />}

                    {/* Desktop Backup Button (Bottom Right) */}
                    <div className="hidden md:block absolute bottom-4 right-4 z-30">
                        <button onClick={downloadBackup} className="bg-white border text-slate-500 hover:text-brand-600 p-2 rounded-lg shadow-sm text-xs font-bold flex items-center gap-2 transition-colors">
                            <Icon name="download" size={16} /> YEDEKLE
                        </button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>